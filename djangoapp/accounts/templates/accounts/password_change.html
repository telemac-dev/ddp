{% extends 'base.html' %}
{% load static %}

{% block title %}Alterar Senha - Sistema ERP{% endblock %}

{% block content %}
<div class="page-header">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'accounts:profile' %}">Meu Perfil</a></li>
            <li class="breadcrumb-item active">Alterar Senha</li>
        </ol>
    </nav>
    <h1 class="page-title">Alterar Senha</h1>
    <p class="page-subtitle">Mantenha sua conta segura com uma senha forte</p>
</div>

<div class="row g-4">
    <div class="col-12 col-lg-6 mx-auto">
        <div class="content-card">
            <div class="text-center mb-4">
                <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-3"
                     style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));">
                    <i class="bi bi-shield-lock" style="font-size: 2.5rem; color: white;"></i>
                </div>
                <h5 class="mb-2">Segurança da Conta</h5>
                <p class="text-muted small">Escolha uma senha forte e única</p>
            </div>

            <form method="post" novalidate>
                {% csrf_token %}
                
                <div class="mb-4">
                    <label for="{{ form.old_password.id_for_label }}" class="form-label">
                        <i class="bi bi-lock me-2"></i>{{ form.old_password.label }}
                    </label>
                    <div class="input-group">
                        {{ form.old_password }}
                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('{{ form.old_password.id_for_label }}', this)">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                    {% if form.old_password.errors %}
                        <div class="text-danger mt-2">
                            {% for error in form.old_password.errors %}
                                <small><i class="bi bi-exclamation-circle me-1"></i>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="mb-4">
                    <label for="{{ form.new_password1.id_for_label }}" class="form-label">
                        <i class="bi bi-key me-2"></i>{{ form.new_password1.label }}
                    </label>
                    <div class="input-group">
                        {{ form.new_password1 }}
                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('{{ form.new_password1.id_for_label }}', this)">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                    {% if form.new_password1.errors %}
                        <div class="text-danger mt-2">
                            {% for error in form.new_password1.errors %}
                                <small><i class="bi bi-exclamation-circle me-1"></i>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <!-- Password Strength Indicator -->
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">Força da senha:</small>
                            <small id="strengthText" class="fw-semibold"></small>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div id="strengthBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Password Requirements -->
                    <div class="mt-3 p-3 bg-light rounded">
                        <small class="text-muted d-block mb-2"><strong>Requisitos da senha:</strong></small>
                        <ul class="list-unstyled mb-0 small text-muted">
                            <li id="req-length" class="mb-1">
                                <i class="bi bi-circle me-2"></i>Mínimo de 8 caracteres
                            </li>
                            <li id="req-upper" class="mb-1">
                                <i class="bi bi-circle me-2"></i>Pelo menos uma letra maiúscula
                            </li>
                            <li id="req-lower" class="mb-1">
                                <i class="bi bi-circle me-2"></i>Pelo menos uma letra minúscula
                            </li>
                            <li id="req-number" class="mb-1">
                                <i class="bi bi-circle me-2"></i>Pelo menos um número
                            </li>
                            <li id="req-special">
                                <i class="bi bi-circle me-2"></i>Pelo menos um caractere especial
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="{{ form.new_password2.id_for_label }}" class="form-label">
                        <i class="bi bi-key-fill me-2"></i>{{ form.new_password2.label }}
                    </label>
                    <div class="input-group">
                        {{ form.new_password2 }}
                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('{{ form.new_password2.id_for_label }}', this)">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                    {% if form.new_password2.errors %}
                        <div class="text-danger mt-2">
                            {% for error in form.new_password2.errors %}
                                <small><i class="bi bi-exclamation-circle me-1"></i>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="alert alert-info d-flex align-items-start" role="alert">
                    <i class="bi bi-info-circle me-2 mt-1"></i>
                    <div>
                        <strong>Dica de Segurança:</strong> Use uma combinação de letras maiúsculas e minúsculas, números e símbolos. Evite usar informações pessoais óbvias.
                    </div>
                </div>

                <div class="d-flex gap-2 justify-content-end mt-4 pt-4 border-top">
                    <a href="{% url 'accounts:profile' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle me-2"></i>Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-2"></i>Alterar Senha
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Toggle password visibility
    function togglePassword(fieldId, button) {
        const field = document.getElementById(fieldId);
        const icon = button.querySelector('i');
        
        if (field.type === 'password') {
            field.type = 'text';
            icon.classList.remove('bi-eye');
            icon.classList.add('bi-eye-slash');
        } else {
            field.type = 'password';
            icon.classList.remove('bi-eye-slash');
            icon.classList.add('bi-eye');
        }
    }

    // Password strength checker
    const passwordInput = document.getElementById('{{ form.new_password1.id_for_label }}');
    const strengthBar = document.getElementById('strengthBar');
    const strengthText = document.getElementById('strengthText');

    if (passwordInput) {
        passwordInput.addEventListener('input', function() {
            const password = this.value;
            let strength = 0;
            
            // Check requirements
            const hasLength = password.length >= 8;
            const hasUpper = /[A-Z]/.test(password);
            const hasLower = /[a-z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecial = /[^A-Za-z0-9]/.test(password);
            
            // Update requirement indicators
            updateRequirement('req-length', hasLength);
            updateRequirement('req-upper', hasUpper);
            updateRequirement('req-lower', hasLower);
            updateRequirement('req-number', hasNumber);
            updateRequirement('req-special', hasSpecial);
            
            // Calculate strength
            if (hasLength) strength += 20;
            if (hasUpper) strength += 20;
            if (hasLower) strength += 20;
            if (hasNumber) strength += 20;
            if (hasSpecial) strength += 20;
            
            // Update strength bar
            strengthBar.style.width = strength + '%';
            
            // Update color and text
            if (strength <= 40) {
                strengthBar.className = 'progress-bar bg-danger';
                strengthText.textContent = 'Fraca';
                strengthText.className = 'fw-semibold text-danger';
            } else if (strength <= 60) {
                strengthBar.className = 'progress-bar bg-warning';
                strengthText.textContent = 'Média';
                strengthText.className = 'fw-semibold text-warning';
            } else if (strength <= 80) {
                strengthBar.className = 'progress-bar bg-info';
                strengthText.textContent = 'Boa';
                strengthText.className = 'fw-semibold text-info';
            } else {
                strengthBar.className = 'progress-bar bg-success';
                strengthText.textContent = 'Forte';
                strengthText.className = 'fw-semibold text-success';
            }
        });
    }

    function updateRequirement(id, met) {
        const element = document.getElementById(id);
        const icon = element.querySelector('i');
        
        if (met) {
            icon.classList.remove('bi-circle');
            icon.classList.add('bi-check-circle-fill');
            element.classList.remove('text-muted');
            element.classList.add('text-success');
        } else {
            icon.classList.remove('bi-check-circle-fill');
            icon.classList.add('bi-circle');
            element.classList.remove('text-success');
            element.classList.add('text-muted');
        }
    }
</script>
{% endblock %}
